# 001 — User Management: Implementation

## What Was Built

Email-based session authentication with a login page, a dashboard behind `@login_required`, and a sidebar with logout.

## Architecture

### Authentication Flow

1. User submits email + password on `/accounts/login/`
2. `LoginForm` (plain Django `forms.Form`) validates input
3. `login_view` delegates to `accounts.services.authenticate_user`
4. Service calls `django.contrib.auth.authenticate(request, email=, password=)`
5. `EmailBackend` resolves the email to a `CustomUser` and checks the password
6. On success the service returns the user; the view calls `login_user` to create a session
7. Redirect to `?next=` or `/dashboard/`

### Custom User Model

`CustomUser(AbstractUser)` with `username = None`:
- `USERNAME_FIELD = "email"`, `REQUIRED_FIELDS = []`
- `email` is declared as `EmailField(unique=True)`
- `CustomUserManager(BaseUserManager)` implements `create_user` and `create_superuser` with email as primary identifier
- `createsuperuser` management command prompts only for email + password

### Authentication Backend

`accounts.backends.EmailBackend(ModelBackend)`:
- Registered in `settings.AUTHENTICATION_BACKENDS`
- Accepts both `email=` and `username=` kwargs (Django admin sends credentials as `username=`)
- Performs constant-time password hashing on failed lookups to prevent user enumeration

### Service Layer

| Function | Purpose |
|----------|---------|
| `authenticate_user(request, email, password)` | Wraps `django.contrib.auth.authenticate`, returns `CustomUser | None` |
| `login_user(request, user)` | Wraps `django.contrib.auth.login` |

Views and tasks contain zero business logic — all auth logic lives in services and the backend.

### Django Admin

`CustomUserAdmin(UserAdmin)` with:
- `ordering = ("email",)` (required — default `UserAdmin` orders by `username`)
- Custom `fieldsets` and `add_fieldsets` without username
- Search by email, first name, last name

## Files

| File | Role |
|------|------|
| `accounts/models.py` | `CustomUser` model (no username) |
| `accounts/managers.py` | `CustomUserManager` (email-based create) |
| `accounts/backends.py` | `EmailBackend` (email authentication) |
| `accounts/services.py` | Auth service layer |
| `accounts/forms.py` | `LoginForm` (email + password) |
| `accounts/views.py` | `login_view`, `logout_view` |
| `accounts/admin.py` | `CustomUserAdmin` |
| `accounts/urls.py` | `/accounts/login/`, `/accounts/logout/` |
| `dashboard/views.py` | `index` (behind `@login_required`) |
| `dashboard/urls.py` | `/dashboard/` |
| `sencha_qa/settings.py` | `AUTH_USER_MODEL`, `AUTHENTICATION_BACKENDS`, login/logout URLs |
| `templates/accounts/login.html` | Login page template |
| `templates/dashboard/index.html` | Dashboard with sidebar |

## Migrations

1. `accounts/0001_initial.py` — Creates `CustomUser` table (with username, inherited from `AbstractUser`)
2. `accounts/0002_alter_customuser_managers_remove_customuser_username_and_more.py` — Drops `username`, makes `email` unique, swaps manager

## Tests

16 tests across `accounts/tests.py` and `dashboard/tests.py`:

- **LoginPageTests** — page renders, form fields present
- **LoginAuthTests** — valid login redirects, bad password errors, nonexistent email errors, `?next=` preserved, already-authenticated redirect
- **LogoutTests** — POST required, session cleared + redirect
- **AuthenticateUserServiceTests** — service returns user or None
- **DashboardAccessTests** — unauthenticated redirect, authenticated 200, user info displayed, logout form present

All pass with mypy strict mode clean.
