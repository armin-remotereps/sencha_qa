# 006. Create Testing Environment - Implementation

## Overview

Isolated Docker-based testing environments with SSH, VNC, and Playwright CDP access. Each environment runs in its own container with XFCE4 desktop, TigerVNC, OpenSSH, and Chromium. The service layer manages the full lifecycle: image building, container creation with dynamic port mapping, health checking, and teardown. Designed for tasks 007 (AI Tester) and 008 (Test Runs) to consume.

## Architecture

```
Service Layer (environments/services.py)
  |
  |-- Docker Client (get/close)
  |     |-- connects via DOCKER_HOST from settings
  |
  |-- Image Management (build/ensure/exists)
  |     |-- builds from environments/docker/Dockerfile
  |     |-- passes SSH_PASSWORD, VNC_PASSWORD as buildargs
  |
  |-- Container Lifecycle (create/info/remove/list)
  |     |-- dynamic port mapping (Docker assigns random host ports)
  |     |-- name prefix: ENV_CONTAINER_PREFIX-{suffix}
  |
  |-- Health Checks (check/wait)
  |     |-- socket probes on SSH, VNC, CDP ports
  |     |-- polling with configurable timeout/interval
  |
  |-- SSH (connect/execute/close)
  |     |-- paramiko SSHClient with AutoAddPolicy
  |
  |-- VNC (check_vnc_connection)
  |     |-- raw socket RFB protocol banner detection
  |
  |-- Playwright (get_cdp_url/verify)
  |     |-- chromium.connect_over_cdp() via CDP port
  |
  |-- Orchestration (provision/teardown/full_verification)
        |-- provision: ensure image + create container + wait ready
        |-- teardown: remove container (idempotent)
        |-- full_verification: SSH + VNC + Playwright checks
```

## Docker Container

Base: Ubuntu 24.04 with:
- **XFCE4** - Lightweight desktop for VNC visual interaction
- **TigerVNC (Xvnc)** - X server + VNC in one process, 1920x1080 @ 24-bit
- **OpenSSH** - Root login with password auth for AI agent shell access
- **Chromium** - Playwright's Chromium with `--remote-debugging-port=9222` for CDP
- **Supervisord** - Manages all 4 processes with dependency ordering

Exposed ports: `22` (SSH), `5900` (VNC), `9222` (CDP)

### Supervisord Process Order

| Priority | Process | Depends On | Notes |
|----------|---------|------------|-------|
| 10 | sshd | - | SSH server in foreground mode |
| 20 | xvnc | - | TigerVNC providing X display :0 |
| 30 | xfce4 | xvnc | Desktop on display :0, 5s startup grace |
| 40 | chromium | xfce4 | CDP on 0.0.0.0:9222, 5s startup grace |

## Port Mapping Strategy

Containers use **dynamic port mapping** - Docker assigns random available host ports for each container port. This is critical for task 008 where multiple containers run simultaneously.

```python
# Docker API format for port mappings:
# {'22/tcp': [{'HostIp': '0.0.0.0', 'HostPort': '32768'}], ...}

container_info = create_container(client, name_suffix="test-run-42")
# container_info.ports.ssh        -> 32768 (random)
# container_info.ports.vnc        -> 32769 (random)
# container_info.ports.playwright_cdp -> 32770 (random)
```

## Settings

All settings read from `.env` via `python-decouple`:

| Setting | Default | Description |
|---------|---------|-------------|
| `ENV_IMAGE_NAME` | `auto-tester-env` | Docker image name |
| `ENV_IMAGE_TAG` | `latest` | Docker image tag |
| `ENV_SSH_USER` | `root` | SSH username |
| `ENV_SSH_PASSWORD` | `testpass123` | SSH and container root password |
| `ENV_VNC_PASSWORD` | `testpass123` | VNC authentication password |
| `ENV_CONTAINER_PREFIX` | `auto-tester-env` | Container name prefix |
| `ENV_HEALTH_CHECK_TIMEOUT` | `60` | Max seconds to wait for container |
| `ENV_HEALTH_CHECK_INTERVAL` | `2` | Seconds between health check polls |

## Service Functions

### Main Entry Points (for tasks 007/008)

```python
from environments.services import (
    get_docker_client,
    close_docker_client,
    provision_environment,
    teardown_environment,
    full_verification,
)

# Full lifecycle
client = get_docker_client()
try:
    info = provision_environment(client, name_suffix="test-42")
    # info.ports.ssh, info.ports.vnc, info.ports.playwright_cdp
    results = full_verification(client, info)
    # {'ssh': True, 'vnc': True, 'playwright': True}
finally:
    teardown_environment(client, info.container_id)
    close_docker_client(client)
```

### Individual Services

```python
# SSH
ssh = create_ssh_connection(info.ports)
result = execute_ssh_command(ssh, "echo hello")
# result.exit_code, result.stdout, result.stderr
close_ssh_connection(ssh)

# VNC
connected = check_vnc_connection(info.ports)  # True/False

# Playwright
url = get_playwright_cdp_url(info.ports)  # "http://localhost:32770"
ok = verify_playwright_connection(info.ports)  # True/False
```

## Types

All frozen dataclasses in `environments/types.py`:

- `ContainerPorts(ssh, vnc, playwright_cdp)` - mapped host ports
- `ContainerInfo(container_id, name, ports, status)` - container state
- `HealthCheckResult(ssh_ok, vnc_ok, playwright_ok)` - with `all_ok` property
- `SSHResult(exit_code, stdout, stderr)` - SSH command result

## Management Command

```bash
python manage.py test_environment           # full lifecycle test
python manage.py test_environment --rebuild  # force rebuild image
python manage.py test_environment --no-cleanup  # keep container for debugging
```

## Files Created/Modified

### Created
| File | Purpose |
|------|---------|
| `environments/__init__.py` | App package |
| `environments/apps.py` | Django app config |
| `environments/types.py` | Frozen dataclasses |
| `environments/services.py` | All service functions (17 public + 4 private) |
| `environments/tests.py` | 34 mocked unit tests |
| `environments/management/commands/test_environment.py` | Verification command |
| `environments/docker/Dockerfile` | Container image definition |
| `environments/docker/supervisord.conf` | Process management |
| `environments/docker/healthcheck.sh` | Container health check |

### Modified
| File | Change |
|------|--------|
| `auto_tester/settings.py` | Added `environments` to INSTALLED_APPS, added 8 `ENV_*` settings |
| `.env` | Added environment config variables |
| `example.env` | Added environment config variables |

## Test Coverage

34 unit tests across 9 test classes, all external dependencies mocked:

| Class | Tests | Coverage |
|-------|-------|----------|
| DockerClientTests | 2 | Client creation and closing |
| ImageManagementTests | 5 | exists, build, ensure (exists/missing) |
| ContainerLifecycleTests | 6 | create, info, remove, remove NotFound, list |
| HealthCheckTests | 4 | healthy, unhealthy, wait success, wait timeout |
| SSHTests | 3 | connect, execute, close |
| VNCTests | 2 | RFB success, connection failure |
| PlaywrightTests | 3 | CDP URL, connect success, connect failure |
| OrchestrationTests | 4 | provision, teardown, teardown idempotent, full_verification |
| TypeTests | 5 | All dataclass creation and all_ok property |

## Verification

- `python -m mypy . --strict` - 0 issues across 46 files
- `python -m pytest` - 226 tests pass (34 new + 192 existing)
