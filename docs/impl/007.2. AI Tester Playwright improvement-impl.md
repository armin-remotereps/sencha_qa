# 007.2 AI Tester Playwright Improvement - Implementation

## Summary

Refactored the AI agent's browser tools from slow, per-call CDP connections with CSS-selector-based interaction and raw image screenshots to persistent CDP connections, AI-powered natural-language element finding, and question-based screenshots.

## Changes

### New Files (4 services + 4 test files)

| File | Purpose |
|------|---------|
| `agents/services/playwright_session.py` | `PlaywrightSessionManager` - persistent CDP connection (mirrors `SSHSessionManager`) |
| `agents/services/agent_resource_manager.py` | `AgentResourceManager` - unified context manager for SSH + Playwright |
| `agents/services/vision_qa.py` | `answer_screenshot_question()` - sends screenshot + question to vision model |
| `agents/services/element_finder.py` | `find_element_by_description()` - AI-powered element finding by description |
| `agents/tests/test_playwright_session.py` | 9 tests for PlaywrightSessionManager |
| `agents/tests/test_agent_resource_manager.py` | 6 tests for AgentResourceManager |
| `agents/tests/test_vision_qa.py` | 4 tests for vision Q&A |
| `agents/tests/test_element_finder.py` | 8 tests for element finder |

### Modified Files

| File | Change |
|------|--------|
| `agents/types.py` | Added `playwright_session` and `vision_config` to `ToolContext`. Removed `image_base64` from `ToolResult`. |
| `agents/services/tools_browser.py` | Rewrote: persistent session, description-based click/type/hover, question-based screenshot, new `browser_hover`, DRY error handling via `_safe_browser_call()` |
| `agents/services/tools_screen.py` | `take_screenshot` now accepts `question` + `vision_config`, returns text (not image) |
| `agents/services/tool_registry.py` | Updated tool definitions (description/question params), handler wiring, added `browser_hover`. 14 tools total (was 13). |
| `agents/services/agent_loop.py` | Uses `AgentResourceManager`, removed `describe_screenshot()`, removed `image_base64` handling, updated system prompt |
| `agents/services/__init__.py` | Updated exports with all new services |
| `agents/tests/test_tools_browser.py` | Rewritten for new signatures |
| `agents/tests/test_tool_registry.py` | Updated for new ToolContext fields and tool count |
| `agents/tests/test_agent_loop.py` | Replaced SSHSessionManager mock with AgentResourceManager mock, removed image tests |
| `agents/tests/test_tools_screen.py` | Updated take_screenshot tests for question-based interface |
| `agents/tests/test_tools_shell.py` | Removed `image_base64` assertion |
| `agents/tests/test_types.py` | Updated for removed `image_base64` field |

## Architecture

### PlaywrightSessionManager
Mirrors `SSHSessionManager` pattern: lazy connect on first `get_page()`, thread-safe via lock, auto-reconnect on dead browser, clean close on exit.

### AgentResourceManager
Unified lifecycle for both sessions. Created in `run_agent()`, manages both SSH and Playwright in a single `with` block.

### Description-Based Browser Tools
`browser_click/type/hover` accept natural-language descriptions. `element_finder.py` collects visible interactive elements via JS, sends the list to AI, AI returns the element index, which maps to a `[data-at-idx="N"]` CSS selector.

### Question-Based Screenshots
`take_screenshot` and `browser_take_screenshot` accept a `question` parameter. Internally they capture the screenshot, send it to the vision model with the question, and return the text answer directly.

## Test Results

- 396 tests passing (163 in agents module)
- mypy strict: no issues in 33 source files
- Uncle Bob review: critical issues addressed (SRP extraction in element_finder, DRY error handling in tools_browser)

## Verification

E2E verification done manually via `test_agent` management command.
