# 011 — Pagination Refactor: Implementation

## What Was Built

Unified pagination across all 5 paginated views: project list, test case list, upload list, test run list, and test run detail. Replaced fixed page sizes and simple prev/next buttons with user-selectable page sizes, numbered page links with ellipsis, and a reusable pagination partial.

## Architecture

### Shared Helpers (`projects/views.py`)

| Function | Purpose |
|----------|---------|
| `_parse_per_page(request, default)` | Safely parse `per_page` query param, validate against `ALLOWED_PER_PAGE` |
| `_parse_page(request)` | Safely parse `page` query param, default to 1 |
| `_build_query_params(request)` | Build URL-encoded string of all GET params except `page` |
| `_get_elided_page_range(page_obj)` | Convert Django's `get_elided_page_range()` lazy output to `list[int \| str]` |

### Constants

| Constant | Value | Purpose |
|----------|-------|---------|
| `ALLOWED_PER_PAGE` | `[10, 20, 50, 100]` | Valid page size options |
| `DEFAULT_PER_PAGE` | `20` | Default for table-based views |
| `PROJECTS_DEFAULT_PER_PAGE` | `9` | Default for project card grid (3-column layout) |

### Reusable Pagination Partial (`templates/components/pagination.html`)

Receives via template context:
- `page_obj` — Django `Page` object
- `query_params` — pre-built query string (e.g., `&search=foo&per_page=50`)
- `elided_page_range` — list of page numbers and ellipsis strings
- `per_page` — current page size (int)
- `allowed_per_page` — list of valid page size options

Features:
- "Showing X-Y of Z" summary
- Numbered page links with ellipsis via `get_elided_page_range(on_each_side=1, on_ends=1)`
- Previous/Next arrow buttons (disabled when not applicable)
- Per-page dropdown that auto-submits on change, preserving all other query params via hidden fields

### Service Layer Addition (`projects/services.py`)

| Function | Purpose |
|----------|---------|
| `list_completed_uploads_for_project(project)` | Returns completed uploads for a project (extracted from view per SRP) |

## Files Modified

| File | Change |
|------|--------|
| `projects/views.py` | Added 4 helper functions, 3 constants; updated all 5 views to use dynamic per_page, page parsing, query param preservation |
| `projects/services.py` | Added `list_completed_uploads_for_project()` |
| `templates/components/pagination.html` | New reusable pagination partial (75 lines) |
| `templates/projects/list.html` | Replaced ~22 lines inline pagination with `{% include %}` |
| `templates/projects/test_cases.html` | Replaced inline pagination with `{% include %}` |
| `templates/projects/uploads.html` | Replaced inline pagination with `{% include %}` |
| `templates/projects/test_runs.html` | Replaced inline pagination with `{% include %}` |
| `templates/projects/test_run_detail.html` | Replaced inline pagination with `{% include %}` |

## View-by-View Details

| View | Default per_page | Preserved query params |
|------|-----------------|----------------------|
| `project_list` | 9 | `search`, `tag`, `per_page` |
| `test_case_list` | 20 | `search`, `upload`, `per_page` |
| `upload_list` | 20 | `per_page` |
| `test_run_list` | 20 | `per_page` |
| `test_run_detail` | 20 | `per_page` |

## Key Design Decisions

1. **`_parse_per_page` uses `try/except ValueError`** instead of `str.isdigit()` — avoids Unicode edge cases where `isdigit()` returns True but `int()` raises
2. **`_get_elided_page_range` converts lazy strings to `str()`** — Django's `get_elided_page_range()` returns lazy translation proxies for the ellipsis character; explicit conversion ensures template `==` comparison works
3. **`allowed_per_page` passed from views, not hardcoded in template** — single source of truth for valid page sizes
4. **Per-page form uses hidden fields** to preserve all existing query params (search, tag, upload) when changing page size

## Verification

- Mypy strict: `Success: no issues found in 104 source files`
- E2E tested all 5 views via Playwright: page navigation, per-page dropdown, filter preservation, "Showing X-Y of Z" accuracy
