# 010. Client Disconnection & Test Run Abort

## Overview

When a controller client disconnects (network drop, crash, manual close), the system should proactively cancel the active test run, kill the Celery task chain, and mark test cases/runs with a `CANCELLED` status. Additionally, users should be able to manually abort a test run from the UI without disconnecting the controller client.

## Requirements

### 1. New `CANCELLED` Status
- Add `CANCELLED` to `TestRunStatus` choices
- Add `CANCELLED` to `TestRunTestCaseStatus` choices
- `CANCELLED` is a terminal status (like `SUCCESS` and `FAILED`)

### 2. Celery Task Chain Tracking
- Store the Celery chain's root `AsyncResult` ID on the `TestRun` model (new field: `celery_task_id`)
- Set this when `start_test_run()` dispatches the chain

### 3. `abort_test_run()` Service Function
- Revoke the Celery chain using the stored task ID (with `terminate=True`)
- Mark `IN_PROGRESS` pivots as `FAILED` (with result reason: "Test run aborted" or "Client disconnected")
- Mark remaining `CREATED` pivots as `CANCELLED`
- Set `TestRun.status` to `CANCELLED`
- Broadcast all status updates via WebSocket to the UI

### 4. Controller Disconnect Hook
- In `ControllerConsumer._cleanup_connection()`, after marking the agent as disconnected, call `abort_test_run()` for any `STARTED` test run belonging to the project
- This handles: network drops, client crashes, manual client shutdown

### 5. Early-Exit in Celery Tasks
- At the start of `execute_test_run_test_case()`, check if the test run status is `CANCELLED`
- If so, skip execution immediately (don't wait for agent connection, don't run agent loop)

### 6. Abort Button in UI
- Add an "Abort" button on the test run detail page (visible only when test run status is `STARTED`)
- The button calls a new view that triggers `abort_test_run()`
- The button does NOT disconnect the controller client â€” only stops the test run
- After abort, the UI should reflect the `CANCELLED` status via WebSocket updates

### 7. UI Status Display
- `CANCELLED` status should be visually distinct (e.g., gray or orange badge)
- Both the test run list and detail pages should handle the new status
- Test case pivot rows should show `CANCELLED` status appropriately

## Non-Goals
- Re-running only cancelled test cases (future feature)
- Auto-reconnection of the controller client
- Graceful shutdown signaling to the agent loop mid-iteration
