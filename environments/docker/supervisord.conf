# Supervisord configuration for testing environment
# Manages: SSH server, VNC server (Xvnc), XFCE4 desktop, Chromium browser

[supervisord]
# Run in foreground (required for Docker)
nodaemon=true
# Log to stdout/stderr for Docker log collection
logfile=/dev/stdout
logfile_maxbytes=0
pidfile=/var/run/supervisord.pid

[program:sshd]
# SSH server for AI agent access
command=/usr/sbin/sshd -D
autostart=true
autorestart=true
stdout_logfile=/dev/fd/1
stdout_logfile_maxbytes=0
stderr_logfile=/dev/fd/2
stderr_logfile_maxbytes=0
priority=10

[program:xvnc]
# TigerVNC server providing X display :0
# -geometry: Desktop resolution
# -depth: Color depth (24-bit)
# -SecurityTypes VncAuth: Use VNC password authentication
# -PasswordFile: Location of encrypted VNC password
# -AlwaysShared: Allow multiple concurrent VNC connections
command=Xvnc :0 -geometry 1920x1080 -depth 24 -SecurityTypes VncAuth -PasswordFile /root/.vnc/passwd -AlwaysShared
autostart=true
autorestart=true
stdout_logfile=/dev/fd/1
stdout_logfile_maxbytes=0
stderr_logfile=/dev/fd/2
stderr_logfile_maxbytes=0
priority=20

[program:xfce4]
# XFCE4 desktop environment
# Runs on display :0 provided by Xvnc
command=startxfce4
environment=DISPLAY=":0"
autostart=true
autorestart=true
stdout_logfile=/dev/fd/1
stdout_logfile_maxbytes=0
stderr_logfile=/dev/fd/2
stderr_logfile_maxbytes=0
# Wait 5 seconds before considering it successfully started
startsecs=5
# Depends on Xvnc being available
depends_on=xvnc
priority=30

[program:chromium]
# Chromium browser with remote debugging enabled
# --no-sandbox: Required for running as root in container
# --disable-gpu: Disable GPU hardware acceleration (not needed in headless/VNC)
# --remote-debugging-port: CDP endpoint for Playwright
# --remote-debugging-address: Listen on all interfaces (accessible from host)
command=chromium-browser --no-sandbox --disable-gpu --remote-debugging-port=9222
environment=DISPLAY=":0"
autostart=true
autorestart=true
stdout_logfile=/dev/fd/1
stdout_logfile_maxbytes=0
stderr_logfile=/dev/fd/2
stderr_logfile_maxbytes=0
# Wait 5 seconds before considering it successfully started
startsecs=5
# Depends on XFCE4 desktop being available
depends_on=xfce4
priority=40

[program:cdp-forwarder]
command=socat TCP-LISTEN:9223,fork,reuseaddr,bind=0.0.0.0 TCP:127.0.0.1:9222
autostart=true
autorestart=true
stdout_logfile=/dev/fd/1
stdout_logfile_maxbytes=0
stderr_logfile=/dev/fd/2
stderr_logfile_maxbytes=0
depends_on=chromium
priority=50
