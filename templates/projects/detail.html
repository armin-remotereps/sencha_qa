{% extends "dashboard/base_dashboard.html" %}

{% block dashboard_content %}
<div
  x-data="{
    agentConnected: {{ project.agent_connected|yesno:'true,false' }},
    systemInfo: {{ project.agent_system_info|safe }},
    lastConnectedAt: '{{ project.last_connected_at|date:"N j, Y, P"|default:"" }}',
    showApiKey: false,
    showRegenerateModal: false,
    ws: null,

    init() {
      const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      this.ws = new WebSocket(
        protocol + '//' + window.location.host + '/ws/projects/{{ project.id }}/agent-status/'
      );

      this.ws.onmessage = (event) => {
        const data = JSON.parse(event.data);
        if (data.type === 'agent_status') {
          this.agentConnected = data.agent_connected;
          this.systemInfo = data.agent_system_info || {};
          this.lastConnectedAt = data.last_connected_at || '';
        }
      };
    },

    copyApiKey() {
      navigator.clipboard.writeText('{{ project.api_key }}');
    }
  }"
>
  {# BREADCRUMB #}
  <nav class="mb-4 text-sm text-zinc-400">
    <a href="{% url 'projects:list' %}" class="hover:text-zinc-200">Projects</a>
    <span class="mx-1">/</span>
    <span class="text-zinc-200">{{ project.name }}</span>
  </nav>

  {# HEADER #}
  <div class="mb-6 flex items-center justify-between">
    <div class="flex items-center gap-3">
      <h1 class="text-2xl font-bold text-zinc-100">{{ project.name }}</h1>
      <span
        x-show="agentConnected"
        class="inline-flex items-center rounded-full bg-emerald-900/50 px-3 py-1 text-sm font-medium text-emerald-400"
      >
        Connected
      </span>
      <span
        x-show="!agentConnected"
        class="inline-flex items-center rounded-full bg-zinc-800 px-3 py-1 text-sm font-medium text-zinc-500"
      >
        Disconnected
      </span>
    </div>
    <a
      href="{% url 'projects:list' %}"
      class="rounded-md bg-zinc-700 px-4 py-2 text-sm font-medium text-zinc-100 hover:bg-zinc-600"
    >
      Back to Projects
    </a>
  </div>

  {# AGENT SYSTEM INFO (shown only when connected) #}
  <div
    x-show="agentConnected && systemInfo && Object.keys(systemInfo).length > 0"
    class="mb-6 rounded-lg border border-zinc-800 bg-zinc-900 p-5"
  >
    <h2 class="mb-4 text-lg font-semibold text-zinc-100">Agent System Info</h2>
    <div class="grid grid-cols-1 gap-3 sm:grid-cols-2 lg:grid-cols-3">
      <div x-show="systemInfo.os">
        <p class="text-xs font-medium uppercase text-zinc-500">Operating System</p>
        <p class="mt-1 text-sm text-zinc-100" x-text="systemInfo.os"></p>
      </div>
      <div x-show="systemInfo.version">
        <p class="text-xs font-medium uppercase text-zinc-500">Version</p>
        <p class="mt-1 text-sm text-zinc-100" x-text="systemInfo.version"></p>
      </div>
      <div x-show="systemInfo.architecture">
        <p class="text-xs font-medium uppercase text-zinc-500">Architecture</p>
        <p class="mt-1 text-sm text-zinc-100" x-text="systemInfo.architecture"></p>
      </div>
      <div x-show="systemInfo.hostname">
        <p class="text-xs font-medium uppercase text-zinc-500">Hostname</p>
        <p class="mt-1 text-sm text-zinc-100" x-text="systemInfo.hostname"></p>
      </div>
      <div x-show="systemInfo.screen_resolution">
        <p class="text-xs font-medium uppercase text-zinc-500">Screen Resolution</p>
        <p class="mt-1 text-sm text-zinc-100" x-text="systemInfo.screen_resolution"></p>
      </div>
    </div>
  </div>

  {# LAST CONNECTED (shown when disconnected and last_connected_at exists) #}
  <div
    x-show="!agentConnected && lastConnectedAt"
    class="mb-6 rounded-lg border border-zinc-800 bg-zinc-900 p-5"
  >
    <p class="text-sm text-zinc-400">
      Last connected: <span class="text-zinc-100" x-text="lastConnectedAt"></span>
    </p>
  </div>

  {# API KEY SECTION #}
  <div class="mb-6 rounded-lg border border-zinc-800 bg-zinc-900 p-5">
    <h2 class="mb-4 text-lg font-semibold text-zinc-100">API Key</h2>
    <div class="flex items-center gap-3">
      <div class="flex-1">
        <input
          type="text"
          readonly
          :value="showApiKey ? '{{ project.api_key }}' : '••••••••••••••••••••••••••••••••'"
          class="w-full rounded-md border border-zinc-700 bg-zinc-950 px-3 py-2 text-sm text-zinc-100 font-mono"
        />
      </div>
      <button
        @click="showApiKey = !showApiKey"
        class="rounded-md bg-zinc-700 px-3 py-2 text-sm font-medium text-zinc-100 hover:bg-zinc-600"
      >
        <span x-show="!showApiKey">Reveal</span>
        <span x-show="showApiKey">Hide</span>
      </button>
      <button
        @click="copyApiKey()"
        class="rounded-md bg-zinc-700 px-3 py-2 text-sm font-medium text-zinc-100 hover:bg-zinc-600"
      >
        Copy
      </button>
      <button
        @click="showRegenerateModal = true"
        class="rounded-md bg-red-900/50 px-3 py-2 text-sm font-medium text-red-400 hover:bg-red-900"
      >
        Regenerate
      </button>
    </div>
  </div>

  {# CONTROLLER CLIENT SECTION #}
  <div
    x-data="{ showSetup: false, platform: 'unix' }"
    class="mb-6 rounded-lg border border-zinc-800 bg-zinc-900 p-5"
  >
    <h2 class="mb-4 text-lg font-semibold text-zinc-100">Controller Client</h2>
    <div class="flex items-center gap-3">
      <form method="post" action="{% url 'projects:download_controller_client' project_id=project.id %}">
        {% csrf_token %}
        <button
          type="submit"
          class="rounded-md bg-emerald-700 px-4 py-2 text-sm font-medium text-white hover:bg-emerald-600"
        >
          Download Controller Client
        </button>
      </form>
      <button
        @click="showSetup = !showSetup"
        class="rounded-md bg-zinc-700 px-3 py-2 text-sm font-medium text-zinc-100 hover:bg-zinc-600"
      >
        <span x-show="!showSetup">Setup Instructions</span>
        <span x-show="showSetup">Hide Instructions</span>
      </button>
    </div>

    <div x-show="showSetup" x-cloak class="mt-4">
      <div class="mb-3 flex gap-2">
        <button
          @click="platform = 'unix'"
          :class="platform === 'unix'
            ? 'bg-emerald-700 text-white'
            : 'bg-zinc-700 text-zinc-300 hover:bg-zinc-600'"
          class="rounded-md px-3 py-1.5 text-sm font-medium"
        >
          Linux / macOS
        </button>
        <button
          @click="platform = 'cmd'"
          :class="platform === 'cmd'
            ? 'bg-emerald-700 text-white'
            : 'bg-zinc-700 text-zinc-300 hover:bg-zinc-600'"
          class="rounded-md px-3 py-1.5 text-sm font-medium"
        >
          Windows CMD
        </button>
        <button
          @click="platform = 'ps'"
          :class="platform === 'ps'
            ? 'bg-emerald-700 text-white'
            : 'bg-zinc-700 text-zinc-300 hover:bg-zinc-600'"
          class="rounded-md px-3 py-1.5 text-sm font-medium"
        >
          Windows PowerShell
        </button>
      </div>

      <div class="rounded-md border border-zinc-700 bg-zinc-950 p-4">
        <div class="mb-3 rounded-md bg-amber-900/30 border border-amber-700/50 px-3 py-2">
          <p class="text-xs text-amber-400">
            <strong>Requires Python 3.13+</strong> — the setup script will verify your Python version automatically.
          </p>
        </div>
        <ol class="list-decimal space-y-2 pl-5 text-sm text-zinc-300">
          <li>Extract the downloaded ZIP file and <code class="text-emerald-400">cd</code> into the extracted folder</li>
          <li>
            Run the setup script:
            <div x-show="platform === 'unix'" class="mt-1 space-y-1">
              <code class="block rounded bg-zinc-800 px-2 py-1 text-xs text-emerald-400 font-mono">sudo bash controller_client/scripts/setup.sh</code>
              <p class="text-xs text-zinc-500">If your default <code>python3</code> is not 3.13+, specify the binary:</p>
              <code class="block rounded bg-zinc-800 px-2 py-1 text-xs text-zinc-400 font-mono">sudo bash controller_client/scripts/setup.sh --python python3.13</code>
            </div>
            <div x-show="platform === 'cmd'" class="mt-1 space-y-1">
              <code class="block rounded bg-zinc-800 px-2 py-1 text-xs text-emerald-400 font-mono">controller_client\scripts\setup.bat</code>
              <p class="text-xs text-zinc-500">If your default <code>python</code> is not 3.13+, specify the binary:</p>
              <code class="block rounded bg-zinc-800 px-2 py-1 text-xs text-zinc-400 font-mono">controller_client\scripts\setup.bat python3.13</code>
            </div>
            <div x-show="platform === 'ps'" class="mt-1 space-y-1">
              <code class="block rounded bg-zinc-800 px-2 py-1 text-xs text-emerald-400 font-mono">.\controller_client\scripts\setup.ps1</code>
              <p class="text-xs text-zinc-500">If your default <code>python</code> is not 3.13+, specify the binary:</p>
              <code class="block rounded bg-zinc-800 px-2 py-1 text-xs text-zinc-400 font-mono">.\controller_client\scripts\setup.ps1 -Python python3.13</code>
            </div>
          </li>
          <li>The <code class="text-emerald-400">.env</code> file is pre-configured with your project's connection info</li>
          <li>
            Start the client:
            <div x-show="platform === 'unix'" class="mt-1">
              <code class="rounded bg-zinc-800 px-2 py-1 text-xs text-emerald-400 font-mono">controller_client/.venv/bin/python -m controller_client.main</code>
            </div>
            <div x-show="platform === 'cmd'" class="mt-1">
              <code class="rounded bg-zinc-800 px-2 py-1 text-xs text-emerald-400 font-mono">controller_client\.venv\Scripts\python -m controller_client.main</code>
            </div>
            <div x-show="platform === 'ps'" class="mt-1">
              <code class="rounded bg-zinc-800 px-2 py-1 text-xs text-emerald-400 font-mono">controller_client\.venv\Scripts\python -m controller_client.main</code>
            </div>
          </li>
        </ol>
      </div>
    </div>
  </div>

  {# PROJECT PROMPT #}
  <div
    x-data="projectPrompt()"
    class="mb-6 rounded-lg border border-zinc-800 bg-zinc-900 p-5"
  >
    <div class="mb-4 flex items-center justify-between">
      <h2 class="text-lg font-semibold text-zinc-100">Project Prompt</h2>
      <span class="text-xs text-zinc-500" x-text="prompt.length + ' / {{ prompt_max_length }}'"></span>
    </div>
    <p class="mb-3 text-sm text-zinc-400">
      Provide context about your application for the AI agent: URLs, credentials,
      environment details, navigation hints, and known issues.
    </p>
    <textarea
      x-model="prompt"
      maxlength="{{ prompt_max_length }}"
      rows="8"
      placeholder="e.g. App URL: https://staging.myapp.com&#10;Login: admin@test.com / password123&#10;The dashboard takes ~5s to load after login..."
      class="w-full rounded-md border border-zinc-700 bg-zinc-950 px-3 py-2 font-mono text-sm text-zinc-100 placeholder-zinc-600 focus:border-emerald-600 focus:outline-none focus:ring-1 focus:ring-emerald-600"
    ></textarea>
    <p
      x-show="prompt.length > {{ prompt_max_length }} * 0.95"
      class="mt-1 text-xs text-amber-400"
    >
      Approaching character limit
    </p>
    <div class="mt-3 flex items-center gap-3">
      <form
        id="savePromptForm"
        method="post"
        action="{% url 'projects:save_prompt' project_id=project.id %}"
      >
        {% csrf_token %}
        <input type="hidden" name="project_prompt" :value="prompt" />
        <button
          type="submit"
          :disabled="!dirty"
          :class="dirty
            ? 'bg-emerald-700 text-white hover:bg-emerald-600'
            : 'bg-zinc-700 text-zinc-500 cursor-not-allowed'"
          class="rounded-md px-4 py-2 text-sm font-medium"
        >
          Save Prompt
        </button>
      </form>
      <button
        @click="refineWithAI()"
        :disabled="refining || !prompt.trim()"
        :class="refining || !prompt.trim()
          ? 'bg-zinc-700 text-zinc-500 cursor-not-allowed'
          : 'bg-indigo-700 text-white hover:bg-indigo-600'"
        class="rounded-md px-4 py-2 text-sm font-medium"
      >
        <span x-show="!refining">Refine with AI</span>
        <span x-show="refining">Refining...</span>
      </button>
      <span
        x-show="statusMsg"
        x-text="statusMsg"
        :class="statusError ? 'text-red-400' : 'text-emerald-400'"
        class="text-sm"
      ></span>
    </div>
  </div>

  {# NAVIGATION LINKS #}
  <div class="rounded-lg border border-zinc-800 bg-zinc-900 p-5">
    <h2 class="mb-4 text-lg font-semibold text-zinc-100">Project Navigation</h2>
    <div class="flex flex-wrap gap-3">
      <a
        href="{% url 'projects:test_case_list' project_id=project.id %}"
        class="rounded-md bg-emerald-700 px-4 py-2 text-sm font-medium text-white hover:bg-emerald-600"
      >
        Test Cases
      </a>
      <a
        href="{% url 'projects:test_run_list' project_id=project.id %}"
        class="rounded-md bg-emerald-700 px-4 py-2 text-sm font-medium text-white hover:bg-emerald-600"
      >
        Test Runs
      </a>
      <a
        href="{% url 'projects:upload_list' project_id=project.id %}"
        class="rounded-md bg-emerald-700 px-4 py-2 text-sm font-medium text-white hover:bg-emerald-600"
      >
        Uploads
      </a>
    </div>
  </div>

  {# REGENERATE API KEY CONFIRMATION MODAL #}
  <div
    x-show="showRegenerateModal"
    x-cloak
    class="fixed inset-0 z-50 flex items-center justify-center bg-black/60"
    @click.self="showRegenerateModal = false"
  >
    <div
      class="w-full max-w-md rounded-lg border border-zinc-800 bg-zinc-900 p-6"
      @click.stop
    >
      <h2 class="mb-4 text-lg font-semibold text-zinc-100">Regenerate API Key</h2>
      <p class="mb-6 text-sm text-zinc-400">
        This will invalidate the current API key. Any agents using the old key will need to be updated. Are you sure?
      </p>
      <form method="post" action="{% url 'projects:regenerate_api_key' project_id=project.id %}">
        {% csrf_token %}
        <div class="flex justify-end gap-3">
          <button
            type="button"
            @click="showRegenerateModal = false"
            class="rounded-md bg-zinc-700 px-4 py-2 text-sm font-medium text-zinc-300 hover:bg-zinc-600"
          >
            Cancel
          </button>
          <button
            type="submit"
            class="rounded-md bg-red-600 px-4 py-2 text-sm font-semibold text-white hover:bg-red-500"
          >
            Regenerate
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('alpine:init', () => {
  Alpine.data('projectPrompt', () => ({
    prompt: '{{ project.project_prompt|escapejs }}',
    savedPrompt: '{{ project.project_prompt|escapejs }}',
    dirty: false,
    refining: false,
    statusMsg: '',
    statusError: false,

    init() {
      this.$watch('prompt', () => {
        this.dirty = this.prompt !== this.savedPrompt;
      });
    },

    async refineWithAI() {
      this.refining = true;
      this.statusMsg = '';
      this.statusError = false;
      try {
        const csrfToken = document.querySelector('#savePromptForm [name=csrfmiddlewaretoken]').value;
        const resp = await fetch('{% url "projects:refine_prompt" project_id=project.id %}', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken,
          },
          body: JSON.stringify({ prompt: this.prompt }),
        });
        const data = await resp.json();
        if (!resp.ok) {
          this.statusMsg = data.error || 'Refinement failed.';
          this.statusError = true;
          return;
        }
        this.prompt = data.refined_prompt;
        this.statusMsg = 'Refined successfully — review and save.';
      } catch (err) {
        this.statusMsg = 'Could not reach the server.';
        this.statusError = true;
      } finally {
        this.refining = false;
      }
    },
  }));
});
</script>
{% endblock %}
