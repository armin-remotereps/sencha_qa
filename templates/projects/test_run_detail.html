{% extends "dashboard/base_dashboard.html" %}

{% block dashboard_content %}
<div x-data="testRunLive">
  {# BREADCRUMB #}
  <nav class="mb-4 text-sm text-zinc-400">
    <a href="{% url 'projects:list' %}" class="hover:text-zinc-200">Projects</a>
    <span class="mx-1">/</span>
    <a href="{% url 'projects:test_case_list' project_id=project.id %}" class="hover:text-zinc-200">{{ project.name }}</a>
    <span class="mx-1">/</span>
    <a href="{% url 'projects:test_run_list' project_id=project.id %}" class="hover:text-zinc-200">Test Runs</a>
    <span class="mx-1">/</span>
    <span class="text-zinc-200">#{{ test_run.id }}</span>
  </nav>

  {# HEADER #}
  <div class="mb-6 flex items-center justify-between">
    <div class="flex items-center gap-3">
      <h1 class="text-2xl font-bold text-zinc-100">Test Run #{{ test_run.id }}</h1>
      <span x-show="testRunStatus === 'waiting'" class="rounded-full bg-yellow-900/50 px-3 py-1 text-sm text-yellow-400">Waiting</span>
      <span x-show="testRunStatus === 'started'" class="rounded-full bg-blue-900/50 px-3 py-1 text-sm text-blue-400">Started</span>
      <span x-show="testRunStatus === 'done'" class="rounded-full bg-emerald-900/50 px-3 py-1 text-sm text-emerald-400">Done</span>
      <span x-show="testRunStatus === 'cancelled'" class="rounded-full bg-orange-900/50 px-3 py-1 text-sm text-orange-400">Cancelled</span>
    </div>
    <div class="flex items-center gap-3">
      {% if test_run.status == "waiting" and summary.total > 0 %}
      <form method="post" action="{% url 'projects:test_run_start' project_id=project.id test_run_id=test_run.id %}">
        {% csrf_token %}
        <button
          type="submit"
          class="rounded-md bg-emerald-600 px-4 py-2 text-sm font-medium text-white hover:bg-emerald-500"
        >
          Start Run
        </button>
      </form>
      {% endif %}
      {% if test_run.status == "started" %}
      <form
        method="post"
        action="{% url 'projects:test_run_abort' project_id=project.id test_run_id=test_run.id %}"
        onsubmit="return confirm('Abort this test run? In-progress cases will be marked as failed and pending cases as cancelled.')"
      >
        {% csrf_token %}
        <button
          type="submit"
          class="rounded-md bg-orange-600 px-4 py-2 text-sm font-medium text-white hover:bg-orange-500"
        >
          Abort Run
        </button>
      </form>
      {% endif %}
      {% if test_run.status == "done" or test_run.status == "cancelled" %}
      <form method="post" action="{% url 'projects:test_run_redo' project_id=project.id test_run_id=test_run.id %}" onsubmit="return confirm('Reset this test run? All results, logs, and screenshots will be cleared.')">
        {% csrf_token %}
        <button
          type="submit"
          class="rounded-md bg-amber-600 px-4 py-2 text-sm font-medium text-white hover:bg-amber-500"
        >
          Redo Run
        </button>
      </form>
      {% endif %}
      {% if test_run.status == "waiting" %}
      <form method="post" action="{% url 'projects:test_run_delete' project_id=project.id test_run_id=test_run.id %}" onsubmit="return confirm('Delete this test run and all its cases?')">
        {% csrf_token %}
        <button
          type="submit"
          class="rounded-md bg-red-900/50 px-4 py-2 text-sm font-medium text-red-400 hover:bg-red-900"
        >
          Delete Run
        </button>
      </form>
      {% endif %}
      <a
        href="{% url 'projects:test_run_list' project_id=project.id %}"
        class="rounded-md bg-zinc-700 px-4 py-2 text-sm font-medium text-zinc-100 hover:bg-zinc-600"
      >
        Back to Test Runs
      </a>
    </div>
  </div>

  {# SUMMARY CARDS #}
  <div class="mb-6 grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-6">
    <div class="rounded-lg border border-zinc-800 bg-zinc-900 p-4">
      <p class="text-sm text-zinc-400">Total</p>
      <p class="mt-1 text-2xl font-bold text-zinc-100" x-text="summary.total">{{ summary.total }}</p>
    </div>
    <div class="rounded-lg border border-zinc-800 bg-zinc-900 p-4">
      <p class="text-sm text-zinc-400">Created</p>
      <p class="mt-1 text-2xl font-bold text-zinc-300" x-text="summary.created">{{ summary.created }}</p>
    </div>
    <div class="rounded-lg border border-blue-900 bg-blue-950/30 p-4">
      <p class="text-sm text-blue-400">In Progress</p>
      <p class="mt-1 text-2xl font-bold text-blue-300" x-text="summary.in_progress">{{ summary.in_progress }}</p>
    </div>
    <div class="rounded-lg border border-emerald-900 bg-emerald-950/30 p-4">
      <p class="text-sm text-emerald-400">Success</p>
      <p class="mt-1 text-2xl font-bold text-emerald-300" x-text="summary.success">{{ summary.success }}</p>
    </div>
    <div class="rounded-lg border border-red-900 bg-red-950/30 p-4">
      <p class="text-sm text-red-400">Failed</p>
      <p class="mt-1 text-2xl font-bold text-red-300" x-text="summary.failed">{{ summary.failed }}</p>
    </div>
    <div class="rounded-lg border border-orange-900 bg-orange-950/30 p-4">
      <p class="text-sm text-orange-400">Cancelled</p>
      <p class="mt-1 text-2xl font-bold text-orange-300" x-text="summary.cancelled">{{ summary.cancelled }}</p>
    </div>
  </div>

  {# TEST CASES TABLE #}
  {% if cases %}
  <div class="overflow-x-auto rounded-lg border border-zinc-800">
    <table class="w-full text-left text-sm">
      <thead class="border-b border-zinc-800 bg-zinc-900 text-xs uppercase text-zinc-400">
        <tr>
          <th class="px-4 py-3">Test Case</th>
          <th class="px-4 py-3">Status</th>
          <th class="px-4 py-3">Created</th>
          <th class="px-4 py-3">Actions</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-zinc-800">
        {% for pivot in cases %}
        <tr class="bg-zinc-950 hover:bg-zinc-900" data-pivot-id="{{ pivot.id }}">
          <td class="px-4 py-3 font-medium text-zinc-100">{{ pivot.test_case.title }}</td>
          <td class="px-4 py-3">
            <span
              :class="getPivotBadgeClass(pivotStatuses[{{ pivot.id }}] || '{{ pivot.status }}')"
              x-text="getPivotLabel(pivotStatuses[{{ pivot.id }}] || '{{ pivot.status }}')"
            >{{ pivot.get_status_display }}</span>
          </td>
          <td class="px-4 py-3 text-zinc-400">{{ pivot.created_at|date:"M d, Y H:i" }}</td>
          <td class="px-4 py-3 flex items-center gap-2">
            <a
              href="{% url 'projects:test_run_case_detail' project_id=project.id test_run_id=test_run.id pivot_id=pivot.id %}"
              class="rounded-md bg-zinc-700 px-3 py-1.5 text-xs font-medium text-zinc-100 hover:bg-zinc-600"
            >
              View
            </a>
            {% if test_run.status == "waiting" %}
            <form method="post" action="{% url 'projects:test_run_remove_case' project_id=project.id test_run_id=test_run.id pivot_id=pivot.id %}" onsubmit="return confirm('Remove this case from the run?')">
              {% csrf_token %}
              <button type="submit" class="rounded-md bg-red-900/50 px-3 py-1.5 text-xs font-medium text-red-400 hover:bg-red-900">
                Remove
              </button>
            </form>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
  <div class="rounded-lg border border-zinc-800 bg-zinc-900 p-8 text-center">
    <p class="text-zinc-400">No test cases in this run.</p>
  </div>
  {% endif %}

  {# PAGINATION #}
  {% if cases.has_other_pages %}
  <div class="mt-6 flex items-center justify-center gap-2">
    {% if cases.has_previous %}
    <a
      href="?page={{ cases.previous_page_number }}"
      class="rounded-md bg-zinc-800 px-3 py-1.5 text-sm text-zinc-300 hover:bg-zinc-700"
    >
      Previous
    </a>
    {% endif %}
    <span class="text-sm text-zinc-400">
      Page {{ cases.number }} of {{ cases.paginator.num_pages }}
    </span>
    {% if cases.has_next %}
    <a
      href="?page={{ cases.next_page_number }}"
      class="rounded-md bg-zinc-800 px-3 py-1.5 text-sm text-zinc-300 hover:bg-zinc-700"
    >
      Next
    </a>
    {% endif %}
  </div>
  {% endif %}
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('alpine:init', () => {
  Alpine.data('testRunLive', () => ({
    testRunStatus: '{{ test_run.status }}',
    summary: {
      total: {{ summary.total }},
      created: {{ summary.created }},
      in_progress: {{ summary.in_progress }},
      success: {{ summary.success }},
      failed: {{ summary.failed }},
      cancelled: {{ summary.cancelled }}
    },
    pivotStatuses: {
      {% for pivot in cases %}
      {{ pivot.id }}: '{{ pivot.status }}'{% if not forloop.last %},{% endif %}
      {% endfor %}
    },

    getPivotBadgeClass(status) {
      const base = 'rounded-full px-2 py-0.5 text-xs';
      switch(status) {
        case 'created': return base + ' bg-zinc-800 text-zinc-400';
        case 'in_progress': return base + ' bg-blue-900/50 text-blue-400';
        case 'success': return base + ' bg-emerald-900/50 text-emerald-400';
        case 'failed': return base + ' bg-red-900/50 text-red-400';
        case 'cancelled': return base + ' bg-orange-900/50 text-orange-400';
        default: return base + ' bg-zinc-800 text-zinc-400';
      }
    },

    getPivotLabel(status) {
      switch(status) {
        case 'created': return 'Created';
        case 'in_progress': return 'In Progress';
        case 'success': return 'Success';
        case 'failed': return 'Failed';
        case 'cancelled': return 'Cancelled';
        default: return status;
      }
    },

    init() {
      const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      const ws = new WebSocket(
        protocol + '//' + window.location.host + '/ws/projects/{{ project.id }}/test-runs/{{ test_run.id }}/'
      );

      ws.onmessage = (event) => {
        const data = JSON.parse(event.data);

        if (data.type === 'current_state') {
          this.testRunStatus = data.test_run_status;
          this.summary = data.summary;
          this.pivotStatuses = Object.fromEntries(
            data.pivots.map(p => [p.pivot_id, p.status])
          );
          return;
        }

        if (data.type === 'pivot_status') {
          this.pivotStatuses[data.pivot_id] = data.status;
          this.summary = data.summary;
          return;
        }

        if (data.type === 'test_run_status') {
          const prev = this.testRunStatus;
          this.testRunStatus = data.test_run_status;
          this.summary = data.summary;
          if ((data.test_run_status === 'done' || data.test_run_status === 'cancelled') && prev !== data.test_run_status) {
            setTimeout(() => window.location.reload(), 1500);
          }
          return;
        }
      };
    }
  }));
});
</script>
{% endblock %}
